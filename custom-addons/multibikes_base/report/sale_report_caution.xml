<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Héritage du rapport de devis/commande standard pour ajouter les cautions -->
    <template id="report_saleorder_document_with_caution" inherit_id="sale.report_saleorder_document">
        
        <!-- Ajout d'une colonne pour les cautions dans l'en-tête du tableau -->
        <xpath expr="//th[@name='th_subtotal']" position="before">
            <th name="th_caution_unit" class="text-end">Caution Unitaire</th>
            <th name="th_caution_subtotal" class="text-end">Total Caution</th>
        </xpath>

        <!-- Ajout des cellules caution dans le corps du tableau -->
        <xpath expr="//td[@name='td_subtotal']" position="before">
            <td name="td_caution_unit" class="text-end">
                <span t-if="line.product_id and line.product_id.product_tmpl_id.mb_caution > 0" 
                      t-field="line.product_id.product_tmpl_id.mb_caution"/>
            </td>
            <td name="td_caution_subtotal" class="text-end">
                <t t-if="line.product_id and line.product_id.product_tmpl_id.mb_caution > 0">
                    <t t-set="caution_line_total" t-value="line.product_uom_qty * line.product_id.product_tmpl_id.mb_caution"/>
                    <span t-out="caution_line_total" 
                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                </t>
            </td>
        </xpath>

        <!-- Ajout du total des cautions dans la section des totaux -->
        <xpath expr="//div[@id='total']//table//t[@t-call='sale.document_tax_totals']" position="after">
            <t t-set="total_cautions" t-value="0"/>
            <t t-foreach="doc.order_line" t-as="caution_line">
                <t t-if="caution_line.product_id and caution_line.product_id.product_tmpl_id.mb_caution > 0">
                    <t t-set="total_cautions" t-value="total_cautions + (caution_line.product_uom_qty * caution_line.product_id.product_tmpl_id.mb_caution)"/>
                </t>
            </t>
            
            <tr t-if="total_cautions > 0" class="border-black o_total">
                <td><strong>Total Cautions :</strong></td>
                <td class="text-end">
                    <span t-out="total_cautions" 
                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                </td>
            </tr>
        </xpath>
    </template>

    <!-- Action de rapport pour les devis avec cautions -->
    <record id="action_report_saleorder_with_caution" model="ir.actions.report">
        <field name="name">Devis / Commande avec Cautions</field>
        <field name="model">sale.order</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">sale.report_saleorder</field>
        <field name="report_file">sale.report_saleorder</field>
        <field name="print_report_name">'Devis - %s' % object.name</field>
        <field name="binding_model_id" ref="sale.model_sale_order"/>
        <field name="binding_type">report</field>
    </record>

    <!-- Template pour facture de caution uniquement -->
    <template id="report_caution_only_document">
        <t t-call="web.external_layout">
            <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)" />
            <t t-set="o" t-value="doc"/>
            <t t-set="company" t-value="doc.company_id"/>
            <t t-set="address">
                <div t-field="doc.partner_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}' />
            </t>

            <div class="page">
                <div class="oe_structure"/>

                <h2 class="mt-4">
                    <span>Facture de Caution n° </span>
                    <span t-field="doc.name"/>
                </h2>

                <div class="row mt-4 mb-4" id="informations">
                    <div t-if="doc.client_order_ref" class="col-auto mw-100 mb-2">
                        <strong>Référence Commande :</strong>
                        <p class="m-0" t-field="doc.client_order_ref"/>
                    </div>
                    <div t-if="doc.date_order" class="col-auto mw-100 mb-2">
                        <strong>Date :</strong>
                        <p class="m-0" t-field="doc.date_order" t-options='{"widget": "date"}'/>
                    </div>
                    <div t-if="doc.user_id.name" class="col-auto mw-100 mb-2">
                        <strong>Commercial :</strong>
                        <p class="m-0" t-field="doc.user_id"/>
                    </div>
                </div>

                <!-- Tableau des cautions uniquement -->
                <table class="table table-sm o_main_table table-borderless">
                    <thead>
                        <tr>
                            <th class="text-start">Description</th>
                            <th class="text-end">Quantité</th>
                            <th class="text-end">Caution Unitaire</th>
                            <th class="text-end">Total Caution</th>
                            <th class="text-end">Valeur en cas de Vol</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-set="total_deposits" t-value="0"/>
                        <t t-foreach="doc.order_line.filtered(lambda l: l.product_id and l.product_id.product_tmpl_id.mb_caution > 0)" t-as="line">
                            <t t-set="line_deposit_total" t-value="line.product_uom_qty * line.product_id.product_tmpl_id.mb_caution"/>
                            <t t-set="total_deposits" t-value="total_deposits + line_deposit_total"/>
                            
                            <tr>
                                <td><span t-field="line.name"/></td>
                                <td class="text-end">
                                    <span t-field="line.product_uom_qty"/>
                                    <span t-field="line.product_uom" groups="uom.group_uom"/>
                                </td>
                                <td class="text-end">
                                    <span t-field="line.product_id.product_tmpl_id.mb_caution" 
                                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                                <td class="text-end">
                                    <span t-out="line_deposit_total" 
                                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                                <td class="text-end">
                                    <span t-field="line.product_id.product_tmpl_id.mb_value_in_case_of_theft" 
                                          t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>

                <div class="clearfix" name="caution_total_summary">
                    <div id="total" class="row" name="total">
                        <div class="col-6 ms-auto">
                            <table class="table table-sm table-borderless">
                                <tr class="border-black o_total">
                                    <td><strong>Total Cautions :</strong></td>
                                    <td class="text-end">
                                        <span t-out="total_deposits" 
                                              t-options='{"widget": "monetary", "display_currency": doc.currency_id}'/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-3">
                    <strong>Informations sur les Cautions :</strong><br/>
                    Cette facture couvre les cautions de sécurité pour les articles loués. Les cautions seront remboursées lors du retour des articles en bon état.
                    En cas de vol ou de perte totale, les montants listés dans la colonne "Valeur en cas de Vol" seront facturés.
                </div>

                <div class="oe_structure"/>
            </div>
        </t>
    </template>

    <!-- Template wrapper pour caution uniquement -->
    <template id="report_caution_only">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="multibikes_base.report_caution_only_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <!-- Action pour le rapport caution uniquement -->
    <record id="action_report_caution_only" model="ir.actions.report">
        <field name="name">Facture de Caution Uniquement</field>
        <field name="model">sale.order</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">multibikes_base.report_caution_only</field>
        <field name="report_file">multibikes_base.report_caution_only</field>
        <field name="print_report_name">'Facture Caution - %s' % (object.name)</field>
        <field name="binding_model_id" ref="sale.model_sale_order"/>
        <field name="binding_type">report</field>
    </record>
</odoo>
