<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue pour les lignes du wizard -->
    <record id="view_rental_extension_wizard_line_tree" model="ir.ui.view">
        <field name="name">rental.extension.wizard.line.tree</field>
        <field name="model">rental.extension.wizard.line</field>
        <field name="arch" type="xml">
            <list editable="bottom">
                <field name="selected" widget="boolean_toggle"/>
                <field name="product_id" readonly="1"/>
                <field name="product_name" readonly="1"/>
                <field name="quantity"/>
                <field name="uom_id" readonly="1"/>
                <field name="order_line_id" invisible="1"/>
                <field name="wizard_id" invisible="1"/>
            </list>
        </field>
    </record>
    <!-- Formulaire pour l'assistant de prolongation avec sélection d'articles -->
    <record id="view_rental_extension_wizard_form" model="ir.ui.view">
        <field name="name">rental.extension.wizard.form</field>
        <field name="model">rental.extension.wizard</field>
        <field name="arch" type="xml">
            <form string="Prolonger la location">
                <sheet>
                    <group>
                        <group>
                            <field name="order_id" readonly="1"/>
                            <field name="start_date" required="1"/>
                            <field name="end_date" required="1"/>
                        </group>
                    </group>
                    <group string="Articles à prolonger">
                        <field name="line_ids" nolabel="1" view_mode="tree" views="view_rental_extension_wizard_line_tree,tree"/>
                    </group>
                    <div class="alert alert-info" role="alert">
                        <p>
                            <i class="fa fa-info-circle"></i>
                            <strong>Information</strong>: Cette action va créer une nouvelle commande de location pour prolonger la période des articles sélectionnés.
                        </p>
                        <p>Les bons de livraison seront automatiquement ajustés :</p>
                        <ul>
                            <li>Les bons de retour existants seront programmés à la date de début de la prolongation</li>
                            <li>De nouveaux bons de livraison et de retour seront créés pour la période de prolongation</li>
                        </ul>
                    </div>
                </sheet>
                <footer>
                    <button name="create_extension_order" string="Prolonger" type="object" class="btn-primary"/>
                    <button string="Annuler" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Modification de la vue formulaire des commandes pour ajouter le bouton et les champs -->
    <record id="view_order_form_inherit_rental_extension" model="ir.ui.view">
        <field name="name">sale.order.form.rental.extension</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_renting.rental_order_form_view"/>
        <field name="arch" type="xml">
            <!-- Ajout du bouton de prolongation dans le header -->
            <xpath expr="//button[@name='action_confirm']" position="after">
                <button name="action_extend_rental" type="object" 
                        string="Prolonger" 
                        class="btn-primary"
                        invisible="is_rental_order == False or state not in ('sale', 'done') or not has_rentable_lines"
                        groups="sales_team.group_sale_salesman"/>
            </xpath>
            
            <!-- Ajout de l'onglet Prolongations -->
            <xpath expr="//notebook" position="inside">
                <page string="Prolongations" invisible="is_rental_order == False">
                    <field name="is_rental_extension" invisible="1"/>
                    <field name="original_rental_id" readonly="1" invisible="is_rental_extension == False"/>
                    
                    <group invisible="is_rental_extension == True">
                        <field name="extension_count" readonly="1"/>
                        <button name="action_view_extensions" type="object" 
                                string="Voir les prolongations" 
                                class="oe_highlight"
                                invisible="extension_count == 0"/>
                        <field name="rental_extensions_ids" nolabel="1" readonly="1" invisible="extension_count == 0"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Ajout à la vue liste des commandes -->
    <record id="view_rental_order_tree_inherit" model="ir.ui.view">
        <field name="name">sale.order.tree.rental.extension</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_renting.rental_order_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='amount_total']" position="after">
                <field name="is_rental_extension"/>
                <field name="original_rental_id" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Ajout d'un filtre pour trouver facilement les prolongations -->
    <record id="view_rental_order_search_inherit" model="ir.ui.view">
        <field name="name">sale.order.search.rental.extension</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale_renting.rental_order_view_search"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <filter string="Prolongations de location" name="rental_extension" domain="[('is_rental_extension', '=', True)]"/>
            </xpath>
        </field>
    </record>
</odoo>