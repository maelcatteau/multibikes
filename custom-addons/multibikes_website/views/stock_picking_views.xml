<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================
             EXTENSION DE LA VUE FORMULAIRE
             ======================================== -->
        
        <record id="view_picking_form_period_transfer" model="ir.ui.view">
            <field name="name">stock.picking.form.period.transfer</field>
            <field name="model">stock.picking</field>
            <field name="inherit_id" ref="stock.view_picking_form"/>
            <field name="arch" type="xml">
                <!-- Ajout d'un groupe "Transfert de P√©riode" apr√®s les informations principales -->
                <xpath expr="//group[@name='other_infos']" position="after">
                    <group string="üîÑ Transfert de P√©riode" 
                           invisible="not is_period_transfer"
                           name="period_transfer_info">
                        <field name="is_period_transfer" readonly="1"/>
                        <field name="period_config_id" readonly="1" 
                               options="{'no_create': True, 'no_edit': True}"/>
                    </group>
                </xpath>
                
                <!-- Ajout des champs invisibles pour la logique -->
                <xpath expr="//field[@name='origin']" position="after">
                    <field name="is_period_transfer" invisible="1"/>
                </xpath>
            </field>
        </record>

        <!-- ========================================
             EXTENSION DE LA VUE LISTE/TREE
             ======================================== -->
        
        <record id="view_picking_list_period_transfer" model="ir.ui.view">
            <field name="name">stock.picking.list.period.transfer</field>
            <field name="model">stock.picking</field>
            <field name="inherit_id" ref="stock.vpicktree"/>
            <field name="arch" type="xml">
                <!-- Ajout d'une colonne pour identifier visuellement les transferts de p√©riode -->
                <xpath expr="//field[@name='state']" position="before">
                    <field name="is_period_transfer" string="üîÑ" widget="boolean" 
                           optional="show"/>
                </xpath>
                
                <!-- Champ invisible pour les filtres -->
                <xpath expr="//field[@name='name']" position="after">
                    <field name="period_config_id" invisible="1"/>
                </xpath>
            </field>
        </record>

        <!-- ========================================
             FILTRES ET RECHERCHE
             ======================================== -->
        
        <record id="stock_picking_search_period_transfer" model="ir.ui.view">
            <field name="name">stock.picking.search.period.transfer</field>
            <field name="model">stock.picking</field>
            <field name="inherit_id" ref="stock.view_picking_internal_search"/>
            <field name="arch" type="xml">
                <!-- Ajout du filtre dans la barre de recherche -->
                <xpath expr="//filter[@name='available']" position="after">
                    <separator/>
                    <filter name="period_transfers" string="üîÑ Transferts de P√©riode"
                            domain="[('is_period_transfer', '=', True)]"
                            help="Afficher uniquement les transferts automatiques de p√©riode"/>
                    <filter name="manual_transfers" string="üì¶ Transferts Manuels"
                            domain="[('is_period_transfer', '=', False)]"
                            help="Afficher uniquement les transferts manuels"/>
                </xpath>
                
                <!-- Groupement par configuration de p√©riode -->
                <xpath expr="//group" position="inside">
                    <filter name="group_by_period_config" string="Configuration de P√©riode" 
                            domain="[]" context="{'group_by': 'period_config_id'}" 
                            invisible="1"/>
                </xpath>
            </field>
        </record>

        <!-- ========================================
             VUE D√âDI√âE AUX TRANSFERTS AUTOMATIQUES
             ======================================== -->
        
        <record id="view_period_transfer_list" model="ir.ui.view">
            <field name="name">period.transfer.list</field>
            <field name="model">stock.picking</field>
            <field name="arch" type="xml">
                <list string="Transferts de P√©riode Automatiques" 
                    create="0" edit="0" delete="0"
                    decoration-success="state == 'done'"
                    decoration-warning="state in ('waiting', 'confirmed')"
                    decoration-info="state == 'assigned'"
                    decoration-muted="state == 'cancel'">
                    
                    <field name="name" string="R√©f√©rence"/>
                    <field name="period_config_id" string="Configuration"/>
                    <field name="location_id" string="Origine"/>
                    <field name="location_dest_id" string="Destination"/>
                    <field name="scheduled_date" string="Date Pr√©vue"/>
                    <field name="date_done" string="Date R√©alis√©e"/>
                    <field name="state" string="√âtat" widget="badge"/>
                    
                    <!-- Champs invisibles pour la logique -->
                    <field name="is_period_transfer" column_invisible="1"/>
                </list>
            </field>
        </record>

        <record id="view_period_transfer_form" model="ir.ui.view">
            <field name="name">period.transfer.form</field>
            <field name="model">stock.picking</field>
            <field name="arch" type="xml">
                <form string="Transfert de P√©riode" create="false" edit="false" delete="false">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="draft,waiting,confirmed,assigned,done"/>
                    </header>
                    
                    <sheet>
                        <!-- Banni√®re d'information -->
                        <div class="alert alert-info" role="alert">
                            <strong>üîÑ Transfert Automatique de P√©riode</strong><br/>
                            Ce transfert a √©t√© cr√©√© automatiquement par le syst√®me saisonnier.
                            Il est prot√©g√© en √©criture pour pr√©server l'int√©grit√© des calculs de disponibilit√©.
                        </div>
                        
                        <group>
                            <group string="Informations G√©n√©rales">
                                <field name="name"/>
                                <field name="period_config_id" options="{'no_create': True, 'no_edit': True}"/>
                                <field name="scheduled_date"/>
                                <field name="date_done"/>
                            </group>
                            
                            <group string="Localisation">
                                <field name="location_id"/>
                                <field name="location_dest_id"/>
                                <field name="picking_type_id"/>
                            </group>
                        </group>
                        
                        <!-- D√©tail des mouvements -->
                        <notebook>
                            <page string="Mouvements de Stock" name="move_lines">
                                <field name="move_line_ids" readonly="1">
                                    <list>
                                        <field name="product_id"/>
                                        <field name="lot_id"/>
                                        <field name="qty_done"/>
                                        <field name="product_uom_id"/>
                                        <field name="location_id"/>
                                        <field name="location_dest_id"/>
                                    </list>
                                </field>
                            </page>
                            
                            <page string="Informations Suppl√©mentaires" name="extra_info">
                                <group>
                                    <field name="origin"/>
                                    <field name="user_id"/>
                                    <field name="company_id"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- ========================================
             ACTION D√âDI√âE AUX TRANSFERTS DE P√âRIODE
             ======================================== -->
        
        <record id="action_period_transfer_picking" model="ir.actions.act_window">
            <field name="name">üîÑ Transferts de P√©riode</field>
            <field name="res_model">stock.picking</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[('is_period_transfer', '=', True)]</field>
            <field name="context">{}</field>
            <field name="view_ids" 
                   eval="[(5, 0, 0),
                          (0, 0, {'view_mode': 'list', 'view_id': ref('view_period_transfer_list')}),
                          (0, 0, {'view_mode': 'form', 'view_id': ref('view_period_transfer_form')})]"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Aucun transfert de p√©riode automatique trouv√© !
                </p>
                <p>
                    Les transferts de p√©riode sont cr√©√©s automatiquement par le syst√®me 
                    lors des changements saisonniers pour d√©placer les v√©los entre les d√©p√¥ts.
                </p>
            </field>
        </record>

        <!-- ========================================
             MENU (OPTIONNEL)
             ======================================== -->
        
        <menuitem id="menu_period_transfers"
                  name="Transferts de P√©riode"
                  parent="stock.menu_stock_warehouse_mgmt"
                  action="action_period_transfer_picking"
                  sequence="50"
                  groups="stock.group_stock_manager"/>

    </data>
</odoo>
